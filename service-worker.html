<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ask Islam ‚Äî Maven Islamic Chatbot</title>
  <meta name="theme-color" content="#166534" />
  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding-bottom: 5rem;
    }
    .msg { max-width: 80%; }
    .typing-dot { animation: blink 1s infinite alternate; }
    @keyframes blink { from{ opacity:.3 } to{ opacity:1 } }
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      text-align: center;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 1000;
    }
    #go-down-btn {
      position: fixed;
      bottom: 6rem;
      right: 1.5rem;
      z-index: 999;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    main {
      padding-bottom: 8rem;
    }
    .whatsapp-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1000;
      width: 3rem;
      height: 3rem;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #25D366;
      color: white;
      border-radius: 50%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .whatsapp-btn:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body class="bg-light text-dark h-100 d-flex flex-column">
  <!-- Header -->
  <header class="sticky-top z-1 bg-white border-bottom shadow-sm py-3">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <div class="rounded-3 bg-success text-white d-grid place-items-center" style="width: 2.25rem; height: 2.25rem; font-size: 1.5rem;">üïã</div>
        <div>
          <h1 class="fw-bold m-0">Ask Islam</h1>
          <p class="text-muted m-0" style="font-size: 0.75rem;">Maven Digital Academy ‚Äî Islamic Chatbot</p>
        </div>
      </div>
      <nav class="d-none d-sm-flex gap-4 fs-6 fw-medium text-dark">
        <a id="hadithLink" href="https://sunnah.com/" target="_blank" class="text-decoration-none text-muted hover-link">Hadith Search</a>
        <a id="quranLink" href="https://quranicaudio.com/" target="_blank" class="text-decoration-none text-muted hover-link">Qur'an Audio</a>
        <a id="prayerLink" href="https://salah.com/" target="_blank" class="text-decoration-none text-muted hover-link">Prayer Time</a>
      </nav>
      <div class="d-flex align-items-center gap-2">
        <button id="darkToggle" class="btn btn-outline-secondary rounded-3">üåì</button>
        <button id="settingsBtn" class="btn btn-success rounded-3 text-white">Settings</button>
      </div>
    </div>
  </header>

  <!-- Chat area -->
  <main class="container py-3 flex-grow-1 overflow-auto">
    <div id="chat" class="d-flex flex-column gap-3"></div>
  </main>

  <!-- Composer -->
  <form id="composer" class="fixed-bottom bg-white border-top p-3">
    <div class="container d-flex gap-2">
      <input id="prompt" type="text" autocomplete="off"
             placeholder="Ask about Qur‚Äôan, Hadith, fasting, prayer‚Ä¶"
             class="form-control rounded-pill bg-light border-0 flex-grow-1" style="box-shadow: none;">
      <button type="submit" class="btn btn-success rounded-pill text-white">Send</button>
    </div>
    <div class="container d-flex gap-2 p-3 text-muted" style="font-size: 0.75rem;">
      <button type="button" id="clearBtn" class="text-decoration-underline btn btn-link p-0">Clear</button>
      <span>‚Ä¢</span>
      <button type="button" id="exportBtn" class="text-decoration-underline btn btn-link p-0">Export</button>
      <span class="ms-auto">Model: <span id="modelLabel" class="fw-bold">gpt-4o-mini</span></span>
    </div>
  </form>

  <!-- Go to bottom button -->
  <button id="go-down-btn" class="btn btn-success rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
    &#x2B07;&#xFE0E;
  </button>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Clear Chat History?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to clear all chat messages? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmClearBtn">Clear All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <dialog id="settings" class="rounded-3 shadow-lg p-0 border-0" style="width: min(42rem, 92vw);">
    <form method="dialog" class="bg-white rounded-3 overflow-hidden">
      <div class="p-4 border-bottom d-flex align-items-center justify-content-between">
        <h3 class="fw-bold m-0">Settings</h3>
        <button class="btn btn-sm btn-outline-secondary rounded-3">Close</button>
      </div>
      <div class="p-4 d-grid gap-2">
        <h5 class="fw-bold">Islamic Resources</h5>
        <a href="https://sunnah.com/" target="_blank" class="btn btn-outline-secondary rounded-3 text-start">
          <span class="me-auto">Hadith Search & Collection</span> &#x2197;&#xFE0E;
        </a>
        <a href="https://quranicaudio.com/" target="_blank" class="btn btn-outline-secondary rounded-3 text-start">
          <span class="me-auto">Qur'an Audio</span> &#x2197;&#xFE0E;
        </a>
        <a href="https://www.islamicfinder.org/islamic-calendar/" target="_blank" class="btn btn-outline-secondary rounded-3 text-start">
          <span class="me-auto">Islamic Calendar</span> &#x2197;&#xFE0E;
        </a>
        <a href="https://salah.com/" target="_blank" class="btn btn-outline-secondary rounded-3 text-start">
          <span class="me-auto">Islamic Prayer Time</span> &#x2197;&#xFE0E;
        </a>
      </div>
      <hr>
      <div class="p-4 d-grid gap-4">
        <div>
          <label class="form-label text-muted">API Key</label>
          <input disabled type="text" class="form-control bg-light text-muted" value="API key is stored.">
          <p class="form-text text-muted m-0">
            For security, the API key must be managed on a server and cannot be placed directly in the website code.
          </p>
        </div>
        <div>
          <label class="form-label text-muted">Model</label>
          <select id="model" class="form-select bg-light rounded-3">
            <option value="gpt-4o-mini">gpt-4o-mini (recommended)</option>
            <option value="gpt-4o">gpt-4o</option>
            <option value="gpt-4.1-mini">gpt-4.1-mini</option>
          </select>
        </div>
        <div class="form-check d-flex align-items-center gap-2">
          <input id="mockMode" type="checkbox" class="form-check-input accent-success">
          <label for="mockMode" class="form-check-label">Offline mock mode (use built-in responses if API is missing)</label>
        </div>
        <div class="d-flex gap-2">
          <button id="saveSettings" type="button" class="btn btn-success rounded-3 text-white">Save</button>
        </div>
      </div>
    </form>
    <a href="https://wa.me/+2347012931845" target="_blank" class="whatsapp-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16">
          <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.543.068 7.92c0 1.35.372 2.651 1.037 3.829L.065 16l4.281-1.355a7.88 7.88 0 0 0 3.654.929c4.366 0 7.92-3.543 7.92-7.92 0-2.064-.993-4.008-2.603-5.503m-.084 11.106-2.607-1.428-1.554.757-1.49-.757-2.607 1.428-1.489-.757-.968 1.428-.756-1.428a6.32 6.32 0 0 1-1.036-1.282l-.968-.757-1.489.757-.756 1.428c-.28.53-.453 1.084-.526 1.666a7.88 7.88 0 0 0 .968 1.428l1.489-.757.756 1.428 1.554-.757 1.49.757 2.607-1.428 1.554.757 1.49-.757 2.607 1.428 1.489-.757.968 1.428.756-1.428-1.489.757-1.554-.757 1.49-.757 2.607 1.428.756-1.428-1.489.757z"/>
        </svg>
      </a>
  </dialog>
  <div id="toast" class="transition-opacity duration-300 ease-in-out"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
  <script>
    // ---------- Defaults ----------
    const DEFAULT_SYSTEM_PROMPT =
`You are an Islamic assistant called "Maven Islamic Chatbot".
Provide authentic, concise answers grounded in the Qur‚Äôan and authentic Hadith (Sahih).
Cite Surah:Ayah or Hadith collection + number when possible.
If unsure or the topic requires scholarly judgment, say:
"Allahu a'lam (Allah knows best). Please consult a qualified scholar."
Avoid politics and sectarian disputes; stick to mainstream teachings.`;

    const STORE = {
      historyKey: 'maven_islam_chat_history',
      settingsKey: 'maven_islam_settings',
      themeKey: 'maven_islam_theme'
    };

    // ---------- State ----------
    let settings = loadSettings();
    let messages = loadHistory();

    // ---------- Elements ----------
    const chatEl = document.getElementById('chat');
    const formEl = document.getElementById('composer');
    const inputEl = document.getElementById('prompt');
    const settingsDlg = document.getElementById('settings');
    const settingsBtn = document.getElementById('settingsBtn');
    const modelEl  = document.getElementById('model');
    const mockEl   = document.getElementById('mockMode');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const darkToggle = document.getElementById('darkToggle');
    const modelLabel = document.getElementById('modelLabel');
    const toastEl = document.getElementById('toast');
    const goDownBtn = document.getElementById('go-down-btn');
    const confirmModalEl = document.getElementById('confirmModal');
    const confirmClearBtn = document.getElementById('confirmClearBtn');
    const confirmModal = new bootstrap.Modal(confirmModalEl);

    // Tone.js Synths for chat sounds
    let userSynth, assistantSynth;
    function createSynths() {
      userSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
      }).toDestination();
      assistantSynth = new Tone.Synth({
        oscillator: { type: "square" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
      }).toDestination();
    }
    createSynths();

    // Play sound based on message role
    function playMessageSound(role) {
      if (role === 'user') {
        userSynth.triggerAttackRelease("C4", "8n");
      } else {
        assistantSynth.triggerAttackRelease("C3", "8n");
      }
    }

    // ---------- Theme ----------
    initTheme();
    darkToggle.addEventListener('click', () => {
      const d = document.documentElement.classList.toggle('dark');
      if (d) {
        document.body.classList.replace('bg-light', 'bg-dark');
        document.body.classList.replace('text-dark', 'text-light');
      } else {
        document.body.classList.replace('bg-dark', 'bg-light');
        document.body.classList.replace('text-light', 'text-dark');
      }
      localStorage.setItem(STORE.themeKey, d ? 'dark' : 'light');
    });

    // ---------- Bootstrap ----------
    renderAll();
    modelLabel.textContent = settings.model;

    // Settings modal
    settingsBtn.addEventListener('click', () => {
      modelEl.value = settings.model || 'gpt-4o-mini';
      mockEl.checked = !!settings.mockMode;
      settingsDlg.showModal();
    });

    saveSettingsBtn.addEventListener('click', () => {
      settings.model = modelEl.value;
      settings.mockMode = mockEl.checked;
      saveSettings();
      modelLabel.textContent = settings.model;
      settingsDlg.close();
      showToast('Settings saved.');
    });

    // Submit
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;
      pushMessage({ role: 'user', content: text });
      inputEl.value = '';
      renderAll();
      playMessageSound('user');
      await respond(text);
    });

    // Export history
    exportBtn.addEventListener('click', () => {
      const lines = messages.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n');
      const blob = new Blob([lines], { type: 'text/plain' });
      const a = Object.assign(document.createElement('a'), {
        href: URL.createObjectURL(blob),
        download: `ask-islam-chat-${Date.now()}.txt`
      });
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Clear history with custom modal
    clearBtn.addEventListener('click', () => {
      confirmModal.show();
    });
    confirmClearBtn.addEventListener('click', () => {
      messages = [botSeed()];
      saveHistory();
      renderAll();
      confirmModal.hide();
    });

    // Go to down button logic
    const chatArea = document.querySelector('main');
    chatArea.addEventListener('scroll', () => {
      if (chatArea.scrollTop < chatArea.scrollHeight - chatArea.clientHeight - 150) {
        goDownBtn.style.display = 'flex';
        setTimeout(() => goDownBtn.style.opacity = '1', 10);
      } else {
        goDownBtn.style.opacity = '0';
        setTimeout(() => goDownBtn.style.display = 'none', 300);
      }
    });
    goDownBtn.addEventListener('click', () => {
      chatArea.scrollTo({
        top: chatArea.scrollHeight,
        behavior: 'smooth'
      });
    });

    // PWA: register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }

    // ---------- Chat logic ----------
    function botSeed(){
      return { role: 'assistant', content:
        "Assalamu Alaikum wa Rahmatullahi wa Barakatuh. Ask me about Qur‚Äôan, Hadith, prayer, fasting, or other Islamic features."
      };
    }
    function loadHistory(){
      try {
        const raw = localStorage.getItem(STORE.historyKey);
        return raw ? JSON.parse(raw) : [botSeed()];
      } catch { return [botSeed()]; }
    }
    function saveHistory(){ localStorage.setItem(STORE.historyKey, JSON.stringify(messages)); }
    function pushMessage(m){ messages.push({ ...m, id: Date.now() + Math.random() }); saveHistory(); }

    function loadSettings(){
      try {
        const raw = localStorage.getItem(STORE.settingsKey);
        return raw ? JSON.parse(raw) : { model: 'gpt-4o-mini', systemPrompt: DEFAULT_SYSTEM_PROMPT, mockMode: false };
      } catch { return { model: 'gpt-4o-mini', systemPrompt: DEFAULT_SYSTEM_PROMPT, mockMode: false }; }
    }
    function saveSettings(){ localStorage.setItem(STORE.settingsKey, JSON.stringify(settings)); }

    function initTheme(){
      const t = localStorage.getItem(STORE.themeKey);
      if (t === 'dark') {
        document.documentElement.classList.add('dark');
        document.body.classList.replace('bg-light', 'bg-dark');
        document.body.classList.replace('text-dark', 'text-light');
      }
    }

    function renderAll(){
      chatEl.innerHTML = '';
      for (const m of messages) {
        const isUser = m.role === 'user';
        const row = document.createElement('div');
        row.className = `d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'}`;

        const bubble = document.createElement('div');
        bubble.className = `msg rounded-3 p-3 shadow-sm border ${
          isUser
          ? 'bg-success text-white border-success'
          : 'bg-light text-dark border-secondary'
        }`;
        bubble.innerText = m.content;

        row.appendChild(bubble);
        chatEl.appendChild(row);
      }
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function showTyping(){
      const row = document.createElement('div');
      row.className = 'd-flex justify-content-start';
      row.id = 'typing';
      const bubble = document.createElement('div');
      bubble.className = 'msg rounded-3 p-3 border bg-light text-muted d-flex align-items-center gap-1';
      bubble.innerHTML = '<span class="typing-dot">‚óè</span><span class="typing-dot">‚óè</span><span class="typing-dot">‚óè</span>';
      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function hideTyping(){
      const t = document.getElementById('typing');
      if (t) t.remove();
    }

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.style.display = 'block';
      setTimeout(() => {
        toastEl.style.display = 'none';
      }, 3000);
    }

    async function respond(userText){
      showTyping();
      const response = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              history: messages.map(m => ({ role: m.role, content: m.content })),
              userPrompt: userText
          })
      });

      hideTyping();
      const data = await response.json();
      pushMessage({ role: 'assistant', content: data.reply });
      renderAll();
      playMessageSound('assistant');
    }
  </script>
</body>
</html>